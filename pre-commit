#!/usr/bin/env bash

# Core Flutter pre-commit hook
export PATH="/c/Users/ENG.Islam/flutter/bin:$PATH"

echo "üöÄ Running Dart linting checks..."

# Check Flutter
if ! command -v flutter &> /dev/null; then
    echo "‚ùå Flutter not found!"
    exit 1
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$')
[ -z "$STAGED_FILES" ] && exit 0

echo "Checking staged Dart files"

# 1. Formatting check
echo "üîç Formatting check..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        cp "$file" "${file}.tmp"
        flutter format "$file" > /dev/null 2>&1
        if ! diff -q "$file" "${file}.tmp" > /dev/null; then
            echo "‚ùå $file needs formatting"
            mv "${file}.tmp" "$file"
            echo "Fix: flutter format $file"
            exit 1
        fi
        rm "${file}.tmp"
    fi
done
echo "‚úÖ Formatting OK"

# 2. Linting check - Analyze whole project but filter to staged files
echo "üîç Linting check..."

# Run analyze on the whole project
LINT_OUTPUT=$(flutter analyze . 2>&1)
LINT_STATUS=$?

if [ $LINT_STATUS -ne 0 ]; then
    # Filter to only show errors for staged files
    STAGED_LINT_ERRORS=""
    for file in $STAGED_FILES; do
        FILE_ERRORS=$(echo "$LINT_OUTPUT" | grep "$file")
        if [ -n "$FILE_ERRORS" ]; then
            STAGED_LINT_ERRORS="$STAGED_LINT_ERRORS\n$FILE_ERRORS"
        fi
    done
    
    # Filter out localization metadata warnings
    FILTERED_ERRORS=$(echo "$STAGED_LINT_ERRORS" | grep -v "missing_required_arb_resource_attribute" | \
                      grep -v "\.arb" | grep -v "translation" | grep -v "metadata")
    
    if [ -n "$FILTERED_ERRORS" ]; then
        echo "‚ùå Linting issues found in staged files:"
        echo "$FILTERED_ERRORS"
        
        if echo "$FILTERED_ERRORS" | grep -q "error ‚Ä¢"; then
            echo "‚ùå Please fix errors"
            exit 1
        else
            echo "‚ö†Ô∏è  Only warnings found"
            read -p "Continue? (y/N): " -n 1 -r
            echo
            [[ $REPLY =~ ^[Yy]$ ]] || exit 1
        fi
    else
        echo "‚úÖ Linting OK (only localization metadata warnings were ignored)"
    fi
else
    echo "‚úÖ Linting OK"
fi

echo "üéâ All checks passed!"
exit 0